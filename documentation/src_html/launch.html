<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>..//GENFIRE/gui/launch</title>
  <meta name="description" content="GENFIRE Documentation">
  <meta name="author" content="Alan (AJ) Pryor, Jr.">  <link rel="stylesheet" href="css/styles.css?v=1.0">
  <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
<code><font color="orange">from </font>PyQt4 <font color="orange">import </font>QtCore, QtGui<br><font color="orange">import </font>matplotlib<br>matplotlib.use("Qt4Agg")<br><font color="orange">import </font><b><font color="orange">GENFIRE</font></b>_MainWindow<br><font color="orange">import </font>ProjectionCalculator<br><font color="orange">import </font>VolumeSlicer<br><font color="orange">import </font>os<br><font color="orange">import </font>sys<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.reconstruct <font color="orange">import </font>ReconstructionParameters<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.gui.utility <font color="orange">import </font>toString<br><font color="orange">import </font><b><font color="orange">GENFIRE</font></b>_qrc<br><br><font color="orange">class </font>GenfireMainWindow(QtGui.QMainWindow):<br>    stop_threads = QtCore.pyqtSignal()<br>    <font color="orange">def </font>closeEvent(self, QCloseEvent):<br>        <font color="orange">self.</font>stop_threads.emit()<br>        GF_logger.listener_thread.wait()<br>        GF_error_logger.listener_thread.wait()<br>        QCloseEvent.accept()<br>    <font color="orange">def </font>__init__(self):<br><br>        ## Superclass constructor<br>        super(GenfireMainWindow,self).__init__()<br><br>        ## Initialize UI<br>        <font color="orange">self.</font>ui = <b><font color="orange">GENFIRE</font></b>_MainWindow.Ui_<b><font color="orange">GENFIRE</font></b>_MainWindow()<br>        <font color="orange">self.</font>ui.setupUi(self)<br><br>        ## Initialize Reconstruction Parameters<br>        <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters = ReconstructionParameters()<br><br>        ## Initialize file paths in text boxes<br>        <font color="orange">self.</font>ui.lineEdit_results.setText(QtCore.QString(os.path.join(os.getcwd(),'results.mrc')))<br><br>        <font color="orange">self.</font>ui.lineEdit_support.setText(QtCore.QString(os.getcwd()))<br><br>        <font color="orange">self.</font>ui.lineEdit_pj.setText(QtCore.QString(os.getcwd()))<br><br>        <font color="orange">self.</font>ui.lineEdit_io.setText(QtCore.QString(os.getcwd()))<br><br>        <font color="orange">self.</font>ui.lineEdit_angle.setText(QtCore.QString(os.getcwd()))<br><br><br>        ## Push Buttons -- connect each to their main function and check if the reconstruction parameters are good each<br>        ## time a parameter is changed<br>        <font color="orange">self.</font>ui.btn_projections.clicked.connect(<font color="orange">self.</font>selectProjectionFile)<br>        <font color="orange">self.</font>ui.btn_projections.clicked.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.btn_angles.clicked.connect(<font color="orange">self.</font>selectAngleFile)<br>        <font color="orange">self.</font>ui.btn_angles.clicked.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.btn_support.clicked.connect(<font color="orange">self.</font>selectSupportFile)<br>        <font color="orange">self.</font>ui.btn_support.clicked.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.btn_io.clicked.connect(<font color="orange">self.</font>selectInitialObjectFile)<br>        <font color="orange">self.</font>ui.btn_io.clicked.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.btn_reconstruct.clicked.connect(<font color="orange">self.</font>startReconstruction)<br>        <font color="orange">self.</font>ui.btn_reconstruct.clicked.connect(<font color="orange">self.</font>checkParameters)<br>        <font color="orange">self.</font>ui.btn_reconstruct.setStyleSheet("background-color: rgb(221,0,0)")<br><br>        <font color="orange">self.</font>ui.btn_displayResults.clicked.connect(<font color="orange">self.</font>displayResults)<br><br>        ## Line Edits -- connect each to their main function and check if the reconstruction parameters are good each<br>        ## time a parameter is changed<br>        <font color="orange">self.</font>ui.lineEdit_pj.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setProjectionFilename)<br>        <font color="orange">self.</font>ui.lineEdit_pj.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_angle.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setAngleFilename)<br>        <font color="orange">self.</font>ui.lineEdit_angle.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_support.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setSupportFilename)<br>        <font color="orange">self.</font>ui.lineEdit_support.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_io.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setInitialObjectFilename)<br>        <font color="orange">self.</font>ui.lineEdit_io.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_results.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setResultsFilename)<br>        <font color="orange">self.</font>ui.lineEdit_results.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_numIterations.setText(QtCore.QString("50"))<br>        <font color="orange">self.</font>ui.lineEdit_numIterations.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setNumberOfIterations)<br>        <font color="orange">self.</font>ui.lineEdit_numIterations.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_oversamplingRatio.setText(QtCore.QString("3"))<br>        <font color="orange">self.</font>ui.lineEdit_oversamplingRatio.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setOversamplingRatio)<br>        <font color="orange">self.</font>ui.lineEdit_oversamplingRatio.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_interpolationCutoffDistance.setText(QtCore.QString("0.7"))<br>        <font color="orange">self.</font>ui.lineEdit_interpolationCutoffDistance.textChanged.connect(<font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setInterpolationCutoffDistance)<br>        <font color="orange">self.</font>ui.lineEdit_interpolationCutoffDistance.textChanged.connect(<font color="orange">self.</font>checkParameters)<br><br>        <font color="orange">self.</font>ui.lineEdit_io.setDisabled(True)<br>        <font color="orange">self.</font>ui.lineEdit_io.setStyleSheet("background-color: gray")<br><br>        ## Radio Buttons -- default is resolution extension suppression<br>        <font color="orange">self.</font>ui.radioButton_on.setChecked(True)<br>        <font color="orange">self.</font>ui.radioButton_on.toggled.connect(<font color="orange">self.</font>selectResolutionExtensionSuppressionState)<br><br>        <font color="orange">self.</font>ui.radioButton_off.toggled.connect(<font color="orange">self.</font>selectResolutionExtensionSuppressionState)<br><br>        <font color="orange">self.</font>ui.radioButton_extension.toggled.connect(<font color="orange">self.</font>selectResolutionExtensionSuppressionState)<br><br><br>        ## Check Boxes<br>        <font color="orange">self.</font>ui.checkBox_rfree.setChecked(True)<br>        <font color="orange">self.</font>ui.checkBox_rfree.toggled.connect(<font color="orange">self.</font>calculateRfree)<br><br>        <font color="orange">self.</font>ui.checkBox_provide_io.toggled.connect(<font color="orange">self.</font>toggleSelectIO)<br><br>        <font color="orange">self.</font>ui.checkBox_default_support.toggled.connect(<font color="orange">self.</font>toggleUseDefaultSupport)<br><br>        <font color="orange">self.</font>ui.action_Create_Support.triggered.connect(<font color="orange">self.</font>launchProjectionCalculator)<br><br>        <font color="orange">self.</font>ui.action_Volume_Slicer.triggered.connect(<font color="orange">self.</font>launchVolumeSlicer)<br><br>    <font color="orange">def </font>calculateRfree(self):<br>        <font color="orange">if </font><font color="orange">self.</font>ui.checkBox_rfree.isChecked() == True:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.calculateRfree = True<br>        else:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.calculateRfree = False<br><br>    <font color="orange">def </font>launchProjectionCalculator(self):<br>        <font color="orange">from </font>functools <font color="orange">import </font>partial<br>        <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ProjectionCalculator = ProjectionCalculator.ProjectionCalculator()<br>        <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.model_loading_signal.connect(partial(<font color="orange">self.</font>receive_msg, "Loading Mo<font color="orange">del.</font>.."))<br>        <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.show()<br><br>    <font color="orange">def </font>launchVolumeSlicer(self):<br>        <font color="orange">import </font><b><font color="orange">GENFIRE</font></b>.fileio<br>        filename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select Volume",filter="Volume files (*.mat *.mrc *.npy);;All Files (*)")<br>        filename = toString(filename)<br>        volume = <b><font color="orange">GENFIRE</font></b>.fileio.loadVolume(filename)<br>        <font color="orange">self.</font>VolumeSlicer = VolumeSlicer.VolumeSlicer(volume)<br>        <font color="orange">self.</font>VolumeSlicer.show()<br><br>    <font color="orange">def </font>toggleSelectIO(self):<br>        <font color="orange">if </font><font color="orange">self.</font>ui.lineEdit_io.isEnabled():<br>             <font color="orange">self.</font>ui.lineEdit_io.setStyleSheet("background-color: gray")<br>             <font color="orange">self.</font>ui.lineEdit_io.setEnabled(False)<br>             <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.initialObjectFilename= ""<br>        else:<br>             <font color="orange">self.</font>ui.lineEdit_io.setStyleSheet("background-color: white")<br>             <font color="orange">self.</font>ui.lineEdit_io.setEnabled(True)<br><br>    <font color="orange">def </font>toggleUseDefaultSupport(self):<br>        <font color="orange">if </font><font color="orange">self.</font>ui.checkBox_default_support.isChecked():<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.useDefaultSupport = True<br>            <font color="orange">self.</font>ui.lineEdit_support.setDisabled(True)<br>            <font color="orange">self.</font>ui.lineEdit_support.setStyleSheet("background-color: gray")<br>        else:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.useDefaultSupport = False<br>            <font color="orange">self.</font>ui.lineEdit_support.setDisabled(False)<br>            <font color="orange">self.</font>ui.lineEdit_support.setStyleSheet("background-color: white")<br><br>    <font color="orange">def </font>messageWritten(self, message):<br>        print message<br>    <font color="orange">def </font>__del__(self):<br>        <font color="orange">import </font>sys<br>        sys.stdout = sys.__stdout__ # Restore output stream to default upon exiting the GUI<br>        sys.stderr = sys.__stderr__<br><br>    #Functions for selecting input files using QFileDialog<br>    <font color="orange">def </font>selectProjectionFile(self):<br>        filename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select File Containing Projections",filter="Projection Stacks (*.mrc *.mat *.t<font color="orange">if </font>*.npy);; MATLAB files (*.mat);;TIFF images (*.t<font color="orange">if </font>*.tiff);;MRC (*.mrc);;All Files (*)")<br><br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setProjectionFilename(filename)<br>            print ("Projection Filename:", <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.getProjectionFilename())<br>            <font color="orange">self.</font>ui.lineEdit_pj.setText(QtCore.QString(filename))<br><br>    <font color="orange">def </font>selectAngleFile(self):<br>        filename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select File Containing Support",filter="Euler Angles (*.txt *.mat);; MATLAB files (*.mat);;text files (*.txt);;All Files (*)")<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setAngleFilename(filename)<br>            print ("Angle Filename:", <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.getAngleFilename())<br>            <font color="orange">self.</font>ui.lineEdit_angle.setText(QtCore.QString(filename))<br><br>    <font color="orange">def </font>selectSupportFile(self):<br>        filename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select File Containing Support", filter="Volume Files (*.mrc *.mat *.npy);; MATLAB files (*.mat);;MRC (*.mrc);;All Files (*)")<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setSupportFilename(filename)<br>            print ("Support Filename:", <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.getSupportFilename())<br>            <font color="orange">self.</font>ui.lineEdit_support.setText(QtCore.QString(filename))<br><br>    <font color="orange">def </font>selectInitialObjectFile(self):<br>        filename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select File Containing Initial Object", filter="Volume Files (*.mrc *.mat *.npy);; MATLAB files (*.mat);;MRC (*.mrc);;All Files (*)")<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setInitialObjectFilename(filename)<br>            print ("Initial Object Filename:", <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.getProjectionFilename())<br>            <font color="orange">self.</font>ui.lineEdit_io.setText(QtCore.QString(filename))<br><br>    #Define constraint enforcement mode<br>    <font color="orange">def </font>selectResolutionExtensionSuppressionState(self):<br>        <font color="orange">if </font><font color="orange">self.</font>ui.radioButton_on.isChecked():<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setResolutionExtensionSuppressionState(1)<br>        <font color="orange">el<font color="orange">if </font></font><font color="orange">self.</font>ui.radioButton_extension.isChecked():<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setResolutionExtensionSuppressionState(3)<br>        else:<br>            <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.setResolutionExtensionSuppressionState(2)<br><br>    <font color="orange">def </font>checkParameters(self):<br>        parametersAreGood = <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters.checkParameters()<br>        <font color="orange">if </font>parametersAreGood: #update "go" button if we are ready<br>            <font color="orange">self.</font>ui.btn_reconstruct.setStyleSheet("background-color: GREEN; color:#ffffff;font-size:30px")<br>            # GF_window.ui.btn_reconstruct.setStyleSheet("color: WHITE")<br>            <font color="orange">self.</font>ui.btn_reconstruct.setText("Launch Reconstruction!")<br><br>    #Function to run GENFIRE reconstruction once all parameters are accounted for<br><br>    @QtCore.pyqtSlot()<br>    <font color="orange">def </font>startReconstruction(self):<br>        print('Launching <b><font color="orange">GENFIRE</font></b> Reconstruction')<br>        # Launch the reconstruction in a separate thread to prevent the GUI blocking while reconstructing<br>        <font color="orange">from </font>threading <font color="orange">import </font>Thread<br>        <font color="orange">from </font>functools <font color="orange">import </font>partial<br>        <font color="orange">import </font><b><font color="orange">GENFIRE</font></b>.main<br>        t = Thread(target=partial(<b><font color="orange">GENFIRE</font></b>.main.main, <font color="orange">self.</font><b><font color="orange">GENFIRE</font></b>_ReconstructionParameters))<br>        t.start()<br><br>    <font color="orange">def </font>displayResults(self):<br>        outputfilename = QtGui.QFileDialog.getOpenFileName(QtGui.QFileDialog(), "Select Reconstruction",filter="Volume files (*.mrc *.mat *.npy)  ;; MATLAB files (*.mat);;text files (*.txt *.tiff);;MRC (*.mrc);;All Files (*)")<br>        outputfilename = toString(outputfilename)<br>        <font color="orange">if </font>outputfilename:<br>            <font color="orange">import </font>numpy as np<br>            <font color="orange">import </font>os<br>            <font color="orange">import </font><b><font color="orange">GENFIRE</font></b>.fileio<br>            <font color="orange">import </font>matplotlib.pyplot as plt<br><br>            initialObject = <b><font color="orange">GENFIRE</font></b>.fileio.loadVolume(outputfilename)<br>            dims = np.shape(initialObject)<br>            n_half_x = int(dims[0]/2) #this assumes even-sized arrays<br>            n_half_y = int(dims[1]/2)<br>            n_half_z = int(dims[2]/2)<br>            reconstructionDisplayWindowSize=dims[0] # array should be cubic<br>            half_window_x = reconstructionDisplayWindowSize//2<br>            half_window_y = reconstructionDisplayWindowSize//2<br>            half_window_z = reconstructionDisplayWindowSize//2<br>            plt.figure()<br>            plt.subplot(233)<br>            plt.imshow(np.squeeze(initialObject[n_half_x, n_half_y-half_window_y:n_half_y+half_window_y, n_half_z-half_window_z:n_half_z+half_window_z]))<br>            plt.title("central YZ slice")<br><br>            plt.subplot(232)<br>            plt.imshow(np.squeeze(initialObject[n_half_x-half_window_x:n_half_x+half_window_x, n_half_y, n_half_z-half_window_z:n_half_z+half_window_z]))<br>            plt.title("central XZ slice")<br><br>            plt.subplot(231)<br>            plt.title("central XY slice")<br>            plt.imshow(np.squeeze(initialObject[n_half_x-half_window_x:n_half_x+half_window_x, n_half_y-half_window_y:n_half_y+half_window_y, n_half_z]))<br><br>            plt.subplot(236)<br>            plt.title("YZ projection")<br>            plt.imshow(np.squeeze(np.sum(initialObject[n_half_x-half_window_x:n_half_x+half_window_x, n_half_y-half_window_y:n_half_y+half_window_y, n_half_z-half_window_z:n_half_z+half_window_z], axis=0)))<br><br>            plt.subplot(235)<br>            plt.title("XZ projection")<br>            plt.imshow(np.squeeze(np.sum(initialObject[n_half_x-half_window_x:n_half_x+half_window_x, n_half_y-half_window_y:n_half_y+half_window_y, n_half_z-half_window_z:n_half_z+half_window_z], axis=1)))<br><br>            plt.subplot(234)<br>            plt.title("XY projection")<br>            plt.imshow(np.squeeze(np.sum(initialObject[n_half_x-half_window_x:n_half_x+half_window_x, n_half_y-half_window_y:n_half_y+half_window_y, n_half_z-half_window_z:n_half_z+half_window_z], axis=2)))<br>            plt.get_current_fig_manager().window.setGeometry(25,25,600, 1200)<br><br>            # now load error curves if they exist<br>            output_base, output_ext = os.path.splitext(outputfilename)<br>            errK_filename = output_base + '_errK.txt'<br>            <font color="orange">if </font>os.path.isfile(errK_filename):<br>                errK = np.loadtxt(errK_filename)<br>                numIterations = np.shape(errK)[0]<br>                plt.figure()<br>                plt.plot(range(0,numIterations),errK)<br><br>                mngr = plt.get_current_fig_manager()<br>                mngr.window.setGeometry(700,25,550, 250)<br>                plt.title("Reciprocal Error vs Iteration Number")<br>                plt.xlabel("Iteration Num")<br>                plt.ylabel("Reciprocal Error")<br>                # plt.setp(plt.gcf(),)<br>            Rfree_filename = output_base + '_Rfree.txt'<br><br>            <font color="orange">if </font>os.path.isfile(Rfree_filename):<br>                Rfree = np.loadtxt(Rfree_filename)<br>                numIterations = np.shape(Rfree)[1]<br>                plt.figure()<br>                plt.title("R-free vs Iteration Number")<br>                mngr = plt.get_current_fig_manager()<br>                mngr.window.setGeometry(700,350,550, 250)<br>                plt.plot(range(0,numIterations),np.mean(Rfree,axis=0))<br>                plt.title("Mean R-free Value vs Iteration Number")<br>                plt.xlabel("Iteration Num")<br>                plt.ylabel('Mean R-free')<br><br><br>                plt.figure(4)<br>                mngr = plt.get_current_fig_manager()<br>                mngr.window.setGeometry(700,650,550, 250)<br>                plt.hold(False)<br>                X = np.linspace(0,1,np.shape(Rfree)[0])<br>                plt.plot(X, Rfree[:,-1])<br>                plt.hold(False)<br>                plt.title("Final Rfree Value vs Spatial Frequency")<br>                plt.xlabel("Spatial Frequency (% of Nyquist)")<br>                plt.ylabel('Rfree')<br><br>            plt.draw()<br>            plt.pause(1e-30) # slight pause forces redraw<br><br>    @QtCore.pyqtSlot(str)<br>    <font color="orange">def </font>receive_msg(self, msg):<br>        global process_finished<br>        <font color="orange">if </font>not process_finished:<br>            <font color="orange">self.</font>ui.log.moveCursor(QtGui.QTextCursor.End)<br>            formatted_msg = "<span style=\" font-size:11pt; font-weight:600; color:#000000;\" >" + msg + "</span/>"<br>            <font color="orange">self.</font>ui.log.append(formatted_msg)<br><br>    @QtCore.pyqtSlot(str)<br>    <font color="orange">def </font>receive_error_msg(self, msg):<br>        global process_finished<br>        <font color="orange">if </font>not process_finished:<br>            <font color="orange">self.</font>ui.log.moveCursor(QtGui.QTextCursor.End)<br>            formatted_msg = "<span style=\" font-size:11pt; font-weight:600; color:#ff0000;\" >" + msg + "</span/>"<br>            <font color="orange">self.</font>ui.log.append(formatted_msg)<br><br>    @QtCore.pyqtSlot()<br>    <font color="orange">def </font>stopRunning(self):<br>        global process_finished<br>        process_finished = True<br><br><font color="orange">class </font>GenfireListener(QtCore.QObject):<br>    message_pending = QtCore.pyqtSignal(str)<br>    <font color="orange">def </font>__init__(self, msg_queue):<br>        super(GenfireListener, self).__init__()<br>        <font color="orange">self.</font>msg_queue = msg_queue<br>        <font color="orange">self.</font>process_finished = False<br><br>    @QtCore.pyqtSlot()<br>    <font color="orange">def </font>run(self):<br>        msg = ''<br>        <font color="orange">while </font>not <font color="orange">self.</font>process_finished:<br>            msg = <font color="orange">self.</font>msg_queue.get() #get next message, blocks if nothing to get<br>            <font color="orange">if </font><font color="orange">self.</font>process_finished:<br>                <font color="orange">self.</font>message_pending.emit(msg)<br>                return<br>            <font color="orange">self.</font>message_pending.emit(msg)<br><br>    @QtCore.pyqtSlot()<br>    <font color="orange">def </font>stopRunning(self):<br>        <font color="orange">self.</font>process_finished = True<br><br><font color="orange">class </font>GenfireWriter(object):<br>    <font color="orange">def </font>__init__(self, msg_queue):<br>        <font color="orange">self.</font>msg_queue = msg_queue<br><br>    <font color="orange">def </font>write(self, message):<br>        <font color="orange">if </font>message != "\n":<br>            <font color="orange">self.</font>msg_queue.put("<b><font color="orange">GENFIRE</font></b>: " + message)<br><br><font color="orange">class </font>GenfireLogger(QtCore.QObject):<br>    <font color="orange">def </font>__init__(self, msg_queue):<br>        super(GenfireLogger, self).__init__()<br>        <font color="orange">self.</font>msg_queue = msg_queue<br>        <font color="orange">self.</font>listener  = GenfireListener(msg_queue=<font color="orange">self.</font>msg_queue)<br>        <font color="orange">self.</font>listener_thread = QtCore.QThread()<br>        <font color="orange">self.</font>listener.moveToThread(<font color="orange">self.</font>listener_thread)<br>        <font color="orange">self.</font>listener_thread.started.connect(<font color="orange">self.</font>listener.run)<br>        <font color="orange">self.</font>listener_thread.start()<br><br>    @QtCore.pyqtSlot()<br>    <font color="orange">def </font>cleanup_thread(self):<br>        global process_finished<br>        <font color="orange">self.</font>listener.process_finished = True<br>        <font color="orange">self.</font>msg_queue.put("Safely Exit.") # write a final message to force i/o threads to unblock and see the exit flag<br>        <font color="orange">if </font><font color="orange">self.</font>listener_thread.isRunning():<br>            <font color="orange">self.</font>listener_thread.quit()<br>            <font color="orange">self.</font>listener_thread.wait()<br><br><font color="orange">def </font>main():<br><br>    # Startup the application<br>    app = QtGui.QApplication(sys.argv)<br>    # app.setStyle('plastique')<br>    app.setStyle('mac')<br><br>    # Create the GUI<br>    GF_window  = GenfireMainWindow()<br><br>    # Render GUI<br>    GF_window.show()<br><br>    # Redirect standard output to the GUI<br>    <font color="orange">from </font>Queue <font color="orange">import </font>Queue<br>    global process_finished<br>    global GF_logger<br>    global GF_error_logger<br>    process_finished = <font color="orange">False </font># flag to control save exit of the i/o threads for logging<br><br>    msg_queue  = Queue()<br>    GF_logger  = GenfireLogger(msg_queue)<br>    sys.stdout = GenfireWriter(msg_queue)<br>    GF_logger.listener.message_pending[str].connect(GF_window.receive_msg)<br><br>    err_msg_queue = Queue()<br>    GF_error_logger  = GenfireLogger(err_msg_queue)<br>    sys.stderr = GenfireWriter(err_msg_queue)<br>    GF_error_logger.listener.message_pending[str].connect(GF_window.receive_error_msg)<br><br>    GF_window.stop_threads.connect(GF_error_logger.cleanup_thread)<br>    GF_window.stop_threads.connect(GF_logger.cleanup_thread)<br><br>    GF_window.stop_threads.connect(GF_error_logger.listener.stopRunning)<br>    GF_window.stop_threads.connect(GF_logger.listener.stopRunning)<br><br>    # Start event loop<br>    sys.exit(app.exec_())<br><br><font color="orange">if </font>__name__ == "__main__":<br>    main()<br><br><br></code></body>
    </html>